// Name: Key Simulation
// ID: cubesterKeySimulation
// Description: Simulate key presses and mouse clicks.
// By: CubesterYT <https://scratch.mit.edu/users/CubesterYT/>
// License: MIT AND MPL-2.0

/* generated l10n code */Scratch.translate.setup({"de":{"_Key Simulation":"Tastensimulation"},"fi":{"_Key Simulation":"Näppäinjäljittely","_backspace":"askelpalautinta","_caps lock":"aakkoslukkoa","_click [BUTTON] mouse button at x: [X] y: [Y] for [SECONDS] seconds and [AND_WAIT]":"napauta hiiren [BUTTON] painiketta sijainnissa x: [X] y: [Y] [SECONDS] sekunnin ajan ja [AND_WAIT]","_continue":"jatka","_control":"control-näppäintä","_delete":"poistonäppäintä","_down arrow":"nuolta alas","_end":"loppunäppäintä","_enter":"enteriä","_escape":"poispääsyä","_home":"kotinäppäintä","_insert":"lisäysnäppäintä","_left":"vasenta","_left arrow":"nuolta vasemmalle","_middle":"keskimmäistä","_move mouse to x: [X] y: [Y]":"siirrä hiiri sijaintiin x: [X] y: [Y]","_page down":"alas-näppäintä","_page up":"ylös-näppäintä","_press [KEY] for [SECONDS] seconds and [AND_WAIT]":"paina [KEY] [SECONDS] sekunnin ajan ja [AND_WAIT]","_right":"oikeaa","_right arrow":"nuolta oikealle","_scroll lock":"vierityslukkoa","_shift":"vaihtonäppäintä","_space":"välilyöntiä","_up arrow":"nuolta ylös","_wait":"odota"},"it":{"_Key Simulation":"Simulazione Tasti","_caps lock":"blocco maiuscole","_click [BUTTON] mouse button at x: [X] y: [Y] for [SECONDS] seconds and [AND_WAIT]":"clicca pulsante [BUTTON] del mouse a x: [X] y: [Y] per [SECONDS] secondi e [AND_WAIT]","_continue":"continua","_delete":"cancella","_down arrow":"freccia giù","_end":"fine","_enter":"invio","_home":"inizio","_insert":"inserisci","_left":"a sinistra","_left arrow":"freccia sinistra","_middle":"centrale","_page down":"pagina giù","_page up":"pagina su","_press [KEY] for [SECONDS] seconds and [AND_WAIT]":"premi [KEY] per [SECONDS] secondi e [AND_WAIT]","_right":"a destra","_right arrow":"freccia destra","_scroll lock":"blocco scorrimento","_space":"spazio","_up arrow":"freccia su","_wait":"attendi"},"ja":{"_Key Simulation":"キーシミュレーション","_backspace":"Backspace","_caps lock":"Caps Lock","_click [BUTTON] mouse button at x: [X] y: [Y] for [SECONDS] seconds and [AND_WAIT]":"マウスの[BUTTON]をx座標[X]y座標[Y]の場所で[SECONDS]秒押して[AND_WAIT]","_continue":"続ける","_control":"Ctrl","_delete":"Delete","_down arrow":"下向き矢印","_end":"End","_enter":"Enter","_escape":"Escape","_home":"Home","_insert":"Insert","_left":"左ボタン","_left arrow":"左向き矢印","_middle":"ホイール","_move mouse to x: [X] y: [Y]":"マウスのx座標を[X]、y座標を[Y]にする","_page down":"Page Down","_page up":"Page Up","_press [KEY] for [SECONDS] seconds and [AND_WAIT]":"[KEY]キーを[SECONDS]秒押して[AND_WAIT]","_right":"右ボタン","_right arrow":"右向き矢印","_scroll lock":"Scroll Lock","_shift":"Shift","_space":"スペース","_up arrow":"上向き矢印","_wait":"待つ"},"ko":{"_Key Simulation":"키 시뮬레이션","_backspace":"백스페이스","_control":"ctrl","_down arrow":"아래쪽 화살표","_enter":"엔터","_escape":"esc","_left":"왼쪽","_left arrow":"왼쪽 화살표","_middle":"가운데","_move mouse to x: [X] y: [Y]":"마우스를 x:[X] y:[Y] (으)로 이동하기","_right":"오른쪽","_right arrow":"오른쪽 화살표","_shift":"시프트","_space":"스페이스","_up arrow":"위쪽 화살표"},"nb":{"_Key Simulation":"Nøkkel simulering","_backspace":"tilbakestill","_control":"kontroll","_delete":"slett","_down arrow":"nedoverpil","_end":"slutt","_enter":"skriv inn","_home":"hjem","_insert":"sett inn","_left":"venstre","_left arrow":"venstre pil","_middle":"middels","_page down":"side ned","_page up":"side opp","_right":"høyre","_right arrow":"høyre pil","_scroll lock":"rullelås","_space":"mellomrom","_up arrow":"oppoverpil"},"nl":{"_Key Simulation":"Toetsen simuleren","_down arrow":"pijltje omlaag","_left":"linker","_left arrow":"pijltje links","_middle":"middelste","_move mouse to x: [X] y: [Y]":"verplaats muis naar x: [X] y: [Y]","_right":"rechter","_right arrow":"pijltje rechts","_space":"spatiebalk","_up arrow":"pijltje omhoog"},"pl":{"_space":"spacja"},"ru":{"_Key Simulation":"Симуляция Клавиш","_backspace":"задний пробел","_caps lock":"лок КАПСА","_click [BUTTON] mouse button at x: [X] y: [Y] for [SECONDS] seconds and [AND_WAIT]":"нажать [BUTTON] кнопку мыши на x: [X] y: [Y] на [SECONDS] секунд и [AND_WAIT]","_continue":"продолжить","_control":"контрол","_delete":"удалить","_down arrow":"стрелка вниз","_end":"конец","_enter":"ввод","_escape":"эскейп","_home":"домой","_insert":"вставить","_left":"левому краю","_left arrow":"стрелка налево","_middle":"середина","_move mouse to x: [X] y: [Y]":"переместить мышь в x: [X] y: [Y]","_page down":"страница вниз","_page up":"страница вверх","_press [KEY] for [SECONDS] seconds and [AND_WAIT]":"нажать [KEY] на [SECONDS] секунд и [AND_WAIT]","_right":"правому краю","_right arrow":"стрелка направо","_scroll lock":"лок кручения","_shift":"шифт","_space":"пробле","_up arrow":"стрелка вверх","_wait":"подождать"},"tr":{"_Key Simulation":"Anahtar Simülasyon"},"uk":{"_Key Simulation":"Симуляція Клавіш","_down arrow":"стрілку вниз","_end":"закінчується","_enter":"увійти","_left":"ліву","_left arrow":"стрілку ліворуч","_middle":"середню","_move mouse to x: [X] y: [Y]":"перемістити вказівник в x: [X] y: [Y]","_right":"праву","_right arrow":"стрілку праворуч","_space":"пробіл","_up arrow":"стрілку вгору"},"zh-cn":{"_Key Simulation":"模拟按键","_caps lock":"CapsLock","_click [BUTTON] mouse button at x: [X] y: [Y] for [SECONDS] seconds and [AND_WAIT]":"在x：[X]y：[Y]点击鼠标[BUTTON][SECONDS]秒并[AND_WAIT]","_continue":"继续","_control":"Ctrl","_down arrow":"↓","_end":"End","_escape":"Esc","_home":"Home","_insert":"Insert","_left":"左键","_left arrow":"←","_middle":"中键","_move mouse to x: [X] y: [Y]":"将鼠标移到 x: [X] y: [Y]","_page down":"PageDown","_page up":"PageUp","_press [KEY] for [SECONDS] seconds and [AND_WAIT]":"按下[KEY]键[SECONDS]秒并[AND_WAIT]","_right":"右键","_right arrow":"→","_scroll lock":"ScrollLock","_space":"空格","_up arrow":"↑","_wait":"等待"}});/* end generated l10n code */(function (Scratch) {
  "use strict";

  const icon = `data:image/svg+xml;,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="64.412" height="64.412"><g stroke-miterlimit="10" data-paper-data="{&quot;isPaintingLayer&quot;:true}" style="mix-blend-mode:normal"><path fill="#bf0000" stroke="maroon" stroke-width="3.5" d="M1.75 32.206c0-16.82 13.636-30.456 30.456-30.456s30.456 13.636 30.456 30.456-13.636 30.456-30.456 30.456S1.75 49.026 1.75 32.206z"/><path fill="none" d="M.066 64.346V.066h64.28v64.28z"/><path fill="#fff" d="M17.988 33.804c-2.648 0-4.768-2.03-4.795-4.795-.136-13.804 5.217-13.443 11.823-13.618 2.547-.067 9.038 0 13.68 0 6.427 0 12.15.676 12.523 13.618.05 1.697-2.146 4.795-4.795 4.795zM20.254 49.022c-2.743 0-4.966-2.147-4.966-4.795l-2.096-9.435c0-.368 2.223 2.526 4.965 2.526h28.097c2.743 0 4.966-3.374 4.966-3.126l-2.096 10.035c0 2.648-2.223 4.795-4.966 4.795z"/><path fill="#bf0000" fill-rule="evenodd" d="M25.604 25.55h3.199l1.374-6.151c.148-.705 1.208-1.202 2.36-1.098.93.08 1.655.543 1.768 1.098l1.374 6.15h3.125c.89 0 1.32.66.705 1.04l-6.598 4.116c-.39.231-1.024.231-1.394 0l-6.62-4.115c-.613-.382-.167-1.04.707-1.04"/></g></svg>`)}`;

  // This is from the Scratch Addons gamepad addon, which normally could be a problem because it is GPLv3,
  // but I (GarboMuffin) wrote that code so there is no problem.
  let getCanvasSize;
  if (window.ResizeObserver) {
    let canvasWidth = Scratch.vm.runtime.stageWidth;
    let canvasHeight = Scratch.vm.runtime.stageHeight;
    const resize = new ResizeObserver((entries) => {
      for (const entry of entries) {
        canvasWidth = entry.contentRect.width;
        canvasHeight = entry.contentRect.height;
      }
    });
    resize.observe(Scratch.vm.runtime.renderer.canvas);
    getCanvasSize = () => [canvasWidth, canvasHeight];
  } else {
    getCanvasSize = () => {
      const rectangle =
        Scratch.vm.runtime.renderer.canvas.getBoundingClientRect();
      return [rectangle.width, rectangle.height];
    };
  }

  let simulatedX = 0;
  let simulatedY = 0;
  const postMouseData = (data) => {
    const [rectangleWidth, rectangleHeight] = getCanvasSize();
    Scratch.vm.postIOData("mouse", {
      ...data,
      canvasWidth: rectangleWidth,
      canvasHeight: rectangleHeight,
      x:
        (simulatedX + Scratch.vm.runtime.stageWidth / 2) *
        (rectangleWidth / Scratch.vm.runtime.stageWidth),
      y:
        (Scratch.vm.runtime.stageHeight / 2 - simulatedY) *
        (rectangleHeight / Scratch.vm.runtime.stageHeight),
    });
  };

  /**
   * @param {unknown} seconds
   * @param {unknown} andWait
   * @param {() => void} callback
   * @returns {Promise<void>|void}
   */
  const doLater = (seconds, andWait, callback) => {
    const ms = Scratch.Cast.toNumber(seconds) * 1000;

    if (Scratch.Cast.toString(andWait) === "and wait") {
      return new Promise((resolve) => {
        setTimeout(() => {
          callback();
          resolve();
        }, ms);
      });
    }

    setTimeout(callback, ms);
    // don't return a Promise at all, otherwise the block waits for 1 frame
  };

  class KeySimulation {
    getInfo() {
      return {
        id: "cubesterKeySimulation",
        name: Scratch.translate("Key Simulation"),
        color1: "#BF0000",
        color2: "#800000",
        menuIconURI: icon,
        docsURI: "https://extensions.turbowarp.org/CubesterYT/KeySimulation",

        blocks: [
          {
            opcode: "pressKey",
            text: Scratch.translate(
              "press [KEY] for [SECONDS] seconds and [AND_WAIT]"
            ),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              KEY: {
                type: Scratch.ArgumentType.STRING,
                menu: "KEYS",
              },
              SECONDS: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0.1",
              },
              AND_WAIT: {
                type: Scratch.ArgumentType.STRING,
                menu: "AND_WAIT",
              },
            },
          },
          {
            opcode: "clickMouse",
            text: Scratch.translate(
              "click [BUTTON] mouse button at x: [X] y: [Y] for [SECONDS] seconds and [AND_WAIT]"
            ),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              BUTTON: {
                type: Scratch.ArgumentType.STRING,
                menu: "BUTTONS",
              },
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              SECONDS: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0.1",
              },
              AND_WAIT: {
                type: Scratch.ArgumentType.STRING,
                menu: "AND_WAIT",
              },
            },
          },
          {
            opcode: "moveMouse",
            text: Scratch.translate("move mouse to x: [X] y: [Y]"),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "0",
              },
            },
          },
        ],
        menus: {
          KEYS: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate({
                  default: "space",
                  description: "Refers to the space key",
                }),
                value: " ",
              },
              { text: Scratch.translate("up arrow"), value: "ArrowUp" },
              { text: Scratch.translate("down arrow"), value: "ArrowDown" },
              { text: Scratch.translate("right arrow"), value: "ArrowRight" },
              { text: Scratch.translate("left arrow"), value: "ArrowLeft" },
              { text: Scratch.translate("enter"), value: "Enter" },
              { text: Scratch.translate("backspace"), value: "Backspace" },
              { text: Scratch.translate("delete"), value: "Delete" },
              { text: Scratch.translate("shift"), value: "Shift" },
              { text: Scratch.translate("caps lock"), value: "CapsLock" },
              { text: Scratch.translate("scroll lock"), value: "ScrollLock" },
              { text: Scratch.translate("control"), value: "Control" },
              { text: Scratch.translate("escape"), value: "Escape" },
              { text: Scratch.translate("insert"), value: "Insert" },
              { text: Scratch.translate("home"), value: "Home" },
              { text: Scratch.translate("end"), value: "End" },
              { text: Scratch.translate("page up"), value: "PageUp" },
              { text: Scratch.translate("page down"), value: "PageDown" },
              "a",
              "b",
              "c",
              "d",
              "e",
              "f",
              "g",
              "h",
              "i",
              "j",
              "k",
              "l",
              "m",
              "n",
              "o",
              "p",
              "q",
              "r",
              "s",
              "t",
              "u",
              "v",
              "w",
              "x",
              "y",
              "z",
              "0",
              "1",
              "2",
              "3",
              "4",
              "5",
              "6",
              "7",
              "8",
              "9",
              "-",
              ",",
              ".",
              "`",
              "=",
              "[",
              "]",
              "\\",
              ";",
              "'",
              "/",
              "~",
              "+",
              "!",
              ":",
              "*",
              "#",
              "(",
              ")",
              "?",
              "<",
              ">",
              "@",
              '"',
            ],
          },
          BUTTONS: {
            acceptReporters: true,
            items: [
              { text: Scratch.translate("left"), value: "0" },
              { text: Scratch.translate("middle"), value: "1" },
              { text: Scratch.translate("right"), value: "2" },
            ],
          },
          AND_WAIT: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("continue"),
                value: "without waiting",
              },
              {
                text: Scratch.translate("wait"),
                value: "and wait",
              },
            ],
          },
        },
      };
    }

    pressKey(args) {
      Scratch.vm.postIOData("keyboard", {
        key: Scratch.Cast.toString(args.KEY),
        isDown: true,
      });

      return doLater(args.SECONDS, args.AND_WAIT, () => {
        Scratch.vm.postIOData("keyboard", {
          key: Scratch.Cast.toString(args.KEY),
          isDown: false,
        });
      });
    }

    clickMouse(args) {
      simulatedX = Scratch.Cast.toNumber(args.X);
      simulatedY = Scratch.Cast.toNumber(args.Y);
      postMouseData({
        isDown: true,
        button: Scratch.Cast.toNumber(args.BUTTON),
      });

      return doLater(args.SECONDS, args.AND_WAIT, () => {
        postMouseData({
          isDown: false,
          button: Scratch.Cast.toNumber(args.BUTTON),
        });
      });
    }

    moveMouse(args) {
      simulatedX = Scratch.Cast.toNumber(args.X);
      simulatedY = Scratch.Cast.toNumber(args.Y);
      postMouseData({});
    }
  }

  Scratch.extensions.register(new KeySimulation());
})(Scratch);
